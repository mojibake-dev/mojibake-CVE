# CVE-2025-52374

**Suggested description:** Use of hardcoded cryptographic key in `Encryption.cs` in hMailServer 5.8.6 and 5.6.9-beta allows attacker to decrypt passwords to other servers from `hMailAdmin.exe.config` file to access other hMailServer admin consoles with configured connections.

**VulnerabilityType Other:** CWE-321: Use of Hard-coded Cryptographic Key

**Vendor of Product:** hMailServer

**Affected Product Code Base:** hMailServer - 5.8.6, 5.6.9-beta

**Affected Component:** `hMailAdmin.exe.config,hmailserver/source/Tools/Administrator/Utilities/Encryption.cs` , `public static string Encrypt(string plainText)`

**Attack Type:** Local

**Impact Information Disclosure:** true

**Attack Vectors:** Attacker can use the encryption key and IV derived from the hard coded salt and password to decrypt the passwords with the same C# function as the source code.

**Reference:**
- hMailServer Exploit: https://github.com/mojibake-dev/hMailEnum
- Generic Exploit: https://github.com/mojibake-dev/belskysGambit
- Blog Post: https://mojibake.dev/belskys-gambit
- Application: https://github.com/hmailserver/hmailserver

**Discoverer:** Eli Samara

**Detailed Explanation:**

Here we see the password taken in when creating a new server connection in the Admin GUI
```cpp
      private void btnSave_Click(object sender, EventArgs e)
      {
         server.hostName = textHostname.Text;
         server.userName = textUsername.Text;
         server.savePassword = radioSavePassword.Checked;

         if (textPassword.Dirty)
            server.encryptedPassword = Encryption.Encrypt(textPassword.Password);

         this.DialogResult = DialogResult.OK;
      }
```
> line 44 in `hmailserver/source/Tools/Administrator/Dialogs/formServerInformation.cs`

using this function, it's encrypted.

```cs
        private static string NOT_SECRET_KEY = "THIS_KEY_IS_NOT_SECRET";

        public static string Encrypt(string plainText)
        {
            // Encryption operates on byte arrays, not on strings.
            byte[] plainTextBytes =
              System.Text.Encoding.Unicode.GetBytes(plainText);

            // Derive a key from the password.
            PasswordDeriveBytes passwordDerivedBytes = new PasswordDeriveBytes(NOT_SECRET_KEY,
                new byte[] {0x49, 0x76, 0x61, 0x6e, 0x20, 0x4d, 0x65, 0x64, 0x76, 0x65, 0x64, 0x65, 0x76});

            // Use Rijndael symmetric algorithm to do the encryption.
            Rijndael rijndaelAlgorithm = Rijndael.Create();
            rijndaelAlgorithm.Key = passwordDerivedBytes.GetBytes(32);
            rijndaelAlgorithm.IV = passwordDerivedBytes.GetBytes(16);

            MemoryStream memoryStream = new MemoryStream();

            CryptoStream cryptoStream = new CryptoStream(memoryStream, rijndaelAlgorithm.CreateEncryptor(), CryptoStreamMode.Write);
            cryptoStream.Write(plainTextBytes, 0, plainTextBytes.Length);
            cryptoStream.Close();

            byte[] encryptedBytes = memoryStream.ToArray();

            return Convert.ToBase64String(encryptedBytes);

        }
```
> line 12 in `hmailserver/source/Tools/Administrator/Utilities/Encryption.cs`

when you save it runs a function to write to a file called `hMailAdmin.exe.config`
```cpp
        public static void Save(UserSettings settings)
        {
            string settingsFile = Path.Combine(CreateSettingsFolder(), "hMailAdmin.exe.config");

            XmlTextWriter writer = new XmlTextWriter(settingsFile, Encoding.UTF8);
            
            try
            {
                writer.Formatting = Formatting.Indented;

                XmlSerializer xmlSerializer = new XmlSerializer(typeof(UserSettings));
                xmlSerializer.Serialize(writer, settings);
            }
```
> line 65 `hmailserver/source/Tools/Administrator/Utilities/Settings/UserSettings.cs`

which creates a file at `%APPDATA%\hMailServer\Administrator\hMailAdmin.exe.config`

```xml
      <Server>
        <hostName>localhost</hostName>
        <userName>Administrator</userName>
        <encryptedPassword>1WWKZ+ZOBmor+9SYwo/fwg==</encryptedPassword>
        <savePassword>true</savePassword>
      </Server>
```

With entries like the following.

The Value is base64 encoded same as the function. 

The hardcoded decryption function will decrypt that string in the `<encryptedPassword>` tag to `test1`.
